<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四渡赤水：从战火到和平</title>
    
    <!-- 1. 核心库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet"> <!-- 用于VS字体 -->

    <!-- 2. 地图与可视化 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 配置主题 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'hist-red': '#ef4444',
                        'hist-gold': '#fbbf24',
                        'ccp-red': '#de2910', /* 党旗红 */
                        'kmt-blue': '#002a86', /* 国民党蓝 */
                    },
                    fontFamily: {
                        serif: ['"Noto Serif SC"', 'serif'],
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                        vs: ['"Black Ops One"', 'cursive'],
                    },
                }
            }
        }
    </script>

    <style>
        /* --- 基础样式 --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Noto Serif SC', serif; 
            background: #111; 
            overflow: hidden; 
            color: #fff;
        }
        
        /* --- 幻灯片容器 --- */
        .page-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1), opacity 0.8s ease;
            transform: translateX(100%); 
            opacity: 0;
            z-index: 1;
            overflow-y: auto;
        }
        
        .page.active { transform: translateX(0); opacity: 1; z-index: 10; }
        .page.prev { transform: translateX(-100%); opacity: 0; z-index: 1; }
        .page.next { transform: translateX(100%); opacity: 0; z-index: 1; }

        /* --- 背景叙事 (色彩流转) --- */
        #page1 { background: linear-gradient(135deg, #dc2626 0%, #be123c 100%); } 
        #page2 { background: linear-gradient(135deg, #be123c 0%, #7c3aed 100%); } 
        #page3 { background: linear-gradient(135deg, #7c3aed 0%, #4338ca 100%); } 
        #page4 { background: linear-gradient(135deg, #4338ca 0%, #2563eb 100%); } 
        #page5 { background: linear-gradient(to top, #3b82f6 0%, #7dd3fc 100%); } 
        
        /* --- 封面元素 --- */
        .cover-title { 
            font-size: clamp(3rem, 8vw, 6rem); 
            font-weight: 900; 
            color: #fff; 
            text-shadow: 0 4px 20px rgba(0,0,0,0.3); 
            letter-spacing: 0.1em;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        
        /* --- 地图样式 --- */
        #map { 
            width: 100%; height: 100%; min-height: 500px; 
            border-radius: 8px; 
            border: 4px solid rgba(255,255,255,0.2); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
            background: #e5e5e5; 
        }
        .leaflet-tile-pane { filter: sepia(0.2) contrast(1.0); }
        .red-army-ball {
            background: radial-gradient(circle at 35% 35%, #ff5252, #b91c1c);
            border: 2px solid #fff; border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            width: 16px !important; height: 16px !important;
            margin-left: -8px !important; margin-top: -8px !important;
            transition: transform 0.2s; cursor: pointer !important; z-index: 9999 !important;
        }
        .red-army-ball:hover { transform: scale(1.5); }
        .ink-path { stroke-linecap: round; stroke-linejoin: round; stroke-opacity: 0.9; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        
        /* --- 导航组件 --- */
        .nav-btn {
            position: absolute; bottom: 50%; transform: translateY(50%);
            width: 60px; height: 60px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; 
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s; color: #fff; z-index: 100;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(8px);
        }
        .nav-btn:hover { background: rgba(255,255,255,0.9); color: #d11a2a; transform: translateY(50%) scale(1.1); }
        .nav-prev { left: 40px; }
        .nav-next { right: 40px; }
        .nav-btn.disabled { opacity: 0; pointer-events: none; }

        /* 语言切换按钮 */
        .lang-switch {
            position: absolute; top: 2rem; left: 2rem; z-index: 200;
            display: flex; border: 1px solid rgba(255,255,255,0.4); border-radius: 4px;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(4px);
        }
        .lang-btn {
            padding: 0.5rem 1rem; font-size: 0.8rem; cursor: pointer; color: rgba(255,255,255,0.7); transition: all 0.3s;
        }
        .lang-btn.active {
            background: rgba(255,255,255,0.2); color: #fff; font-weight: bold;
        }
        .lang-btn:hover { color: #fff; }

        /* --- 页面指示器 --- */
        .page-indicator { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 16px; z-index: 100; }
        .page-dot { width: 40px; height: 3px; background: rgba(255,255,255,0.3); cursor: pointer; transition: all 0.4s; border-radius: 2px; }
        .page-dot.active { background: #fff; width: 60px; }
        
        /* --- 卡片样式 --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            color: #333;
        }

        /* --- Page 2 特定样式 --- */
        .bg-flag-ccp {
            background-image: linear-gradient(rgba(222, 41, 16, 0.85), rgba(222, 41, 16, 0.9)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Flag_of_the_Chinese_Communist_Party.svg/1200px-Flag_of_the_Chinese_Communist_Party.svg.png');
            background-size: cover; background-position: center; color: white !important; border: 2px solid #ffde00;
        }
        .bg-flag-kmt {
            background-image: linear-gradient(rgba(0, 42, 134, 0.85), rgba(0, 42, 134, 0.9)), url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Flag_of_the_Kuomintang.svg/1200px-Flag_of_the_Kuomintang.svg.png');
            background-size: cover; background-position: center; color: white !important; border: 2px solid #fff;
        }
        .text-overlay {
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(4px); border-radius: 8px; padding: 1rem; border: 1px solid rgba(255,255,255,0.2);
        }
        .anim-hidden { opacity: 0; transform: translateY(20px); transition: all 0.8s ease-out; }
        .anim-show { opacity: 1; transform: translateY(0); }
        
        /* 优化后的缓冲动画 */
        .anim-left-hidden { opacity: 0; transform: translateX(-150px); transition: all 1.2s cubic-bezier(0.25, 1, 0.5, 1); }
        .anim-right-hidden { opacity: 0; transform: translateX(150px); transition: all 1.2s cubic-bezier(0.25, 1, 0.5, 1); }
        .anim-slide-in { opacity: 1; transform: translateX(0); }
        
        .collide-left { transform: translateX(30px) rotate(2deg) !important; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .collide-right { transform: translateX(-30px) rotate(-2deg) !important; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .vs-container { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0); z-index: 50; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); opacity: 0; }
        .vs-show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        .vs-text { font-family: 'Black Ops One', cursive; font-size: 6rem; background: linear-gradient(to bottom, #fcd34d, #b91c1c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(255,0,0,0.8)); text-shadow: 2px 2px 0px white; }

        /* --- Page 3 新增：迷你情报窗 --- */
        .mini-window {
            background: #111; border: 1px solid #444; border-radius: 4px; padding: 12px;
            color: #0f0; font-family: 'Courier New', monospace; font-size: 0.8rem;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.2);
            min-height: 80px; display: flex; flex-direction: column; justify-content: center;
            position: relative; overflow: hidden; margin-top: 1rem;
        }
        .mini-window::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(0, 255, 0, 0.5); animation: scan 2s linear infinite; opacity: 0.5;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        /* --- Page 4 新增：激光对抗条 --- */
        .laser-bar-container {
            width: 100%; height: 12px; background: #333; border-radius: 6px; position: relative; overflow: hidden; margin-top: 10px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }
        .laser-red {
            position: absolute; left: 0; top: 0; height: 100%; width: 0%; /* Initial 0 */
            background: linear-gradient(90deg, #b91c1c, #ff5252);
            box-shadow: 0 0 10px #ff5252; z-index: 2;
            transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1) 0.5s; /* Delay start */
        }
        .laser-blue {
            position: absolute; right: 0; top: 0; height: 100%; width: 0%; /* Initial 0 */
            background: linear-gradient(270deg, #1e3a8a, #60a5fa);
            box-shadow: 0 0 10px #60a5fa; z-index: 1;
            transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1) 0.5s;
        }
        .laser-clash {
            position: absolute; top: -50%; height: 200%; width: 2px; background: white;
            filter: blur(4px); box-shadow: 0 0 15px white; z-index: 3; opacity: 0;
            transition: opacity 0.5s; left: 9%; /* Point of clash */
        }
        .animate-lasers .laser-red { width: 9%; }
        .animate-lasers .laser-blue { width: 91%; }
        .animate-lasers .laser-clash { opacity: 1; transition-delay: 1.8s; }

        /* --- 和平鸽动画 & 交互按钮 --- */
        .dove { position: absolute; color: white; opacity: 0.8; animation: fly linear infinite; }
        @keyframes fly {
            0% { transform: translateX(-10vw) translateY(20vh) scale(0.5) rotate(15deg); opacity: 0; }
            20% { opacity: 0.9; }
            80% { opacity: 0.9; }
            100% { transform: translateX(110vw) translateY(-30vh) scale(0.8) rotate(-5deg); opacity: 0; }
        }
        .dove-1 { top: 40%; left: -10%; animation-duration: 18s; }
        .dove-2 { top: 60%; left: -10%; animation-duration: 14s; animation-delay: 3s; }

        .peace-btn-container {
            cursor: pointer; transition: transform 0.3s;
        }
        .peace-btn-container:hover { transform: scale(1.1); }
        .peace-btn-container:active { transform: scale(0.95); }
        
        /* 呼吸闪烁动画 */
        @keyframes breathe {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px 10px rgba(255, 255, 255, 0.2); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        .animate-breathe {
            animation: breathe 3s infinite ease-in-out;
        }
        
        .peace-content {
            opacity: 0; pointer-events: none; transform: translateY(20px); transition: all 0.8s ease-out;
        }
        .peace-content.show {
            opacity: 1; pointer-events: auto; transform: translateY(0);
        }
    </style>
</head>
<body>

    <!-- 语言切换 -->
    <div class="lang-switch">
        <div class="lang-btn active" id="btn-zh" onclick="app.setLanguage('zh')">中文</div>
        <div class="lang-btn" id="btn-en" onclick="app.setLanguage('en')">English</div>
    </div>

    <div class="nav-btn nav-prev disabled" onclick="changePage(-1)" id="btnPrev">
        <i class="fas fa-arrow-left"></i>
    </div>
    <div class="nav-btn nav-next" onclick="changePage(1)" id="btnNext">
        <i class="fas fa-arrow-right"></i>
    </div>

    <div class="page-container">
        
        <!-- Page 1: 封面 -->
        <div class="page active" id="page1">
            <div class="flex flex-col items-center justify-center h-full relative z-10 px-4">
                <div class="text-xs font-bold tracking-[0.6em] uppercase mb-6 text-yellow-300 border border-yellow-300/50 px-4 py-2 rounded-sm bg-black/10 backdrop-blur-sm">1935.01 - 1935.03</div>
                <h1 class="cover-title text-center" data-i18n="title">四渡赤水</h1>
                <p class="text-xl md:text-2xl font-serif italic text-white/90 mt-4 max-w-2xl text-center leading-relaxed" data-i18n="subtitle">
                    "长征史上最光彩神奇的篇章"
                </p>
                <div class="mt-16 grid grid-cols-2 gap-12 text-center">
                    <div class="relative">
                        <div class="text-4xl font-bold text-white mb-2" data-i18n="redArmyCount">3.7<span class="text-lg opacity-70 ml-1">万</span></div>
                        <div class="text-xs tracking-widest text-yellow-200 uppercase" data-i18n="redArmyLabel">Red Army</div>
                    </div>
                    <div class="relative">
                        <div class="text-4xl font-bold text-white mb-2" data-i18n="enemyCount">40<span class="text-lg opacity-70 ml-1">万</span></div>
                        <div class="text-xs tracking-widest text-yellow-200 uppercase" data-i18n="enemyLabel">Opposition</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: 战役背景 -->
        <div class="page p-8 md:p-16 flex flex-col justify-center" id="page2">
            <div class="max-w-6xl mx-auto w-full relative">
                <div id="p2-row1" class="w-full glass-card p-8 border-l-4 border-hist-red mb-12 anim-hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-scroll text-red-600 mr-3"></i><span data-i18n="backgroundTitle">战役背景</span>
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <p class="text-gray-700 leading-8 text-justify font-serif text-lg" data-i18n="backgroundDesc1">
                            1935年1月，遵义会议确立了新的领导核心。此时，中央红军面临着国民党40万大军的铁壁合围，敌我力量对比高达10倍以上。
                        </p>
                        <p class="text-gray-700 leading-8 text-justify font-serif text-lg" data-i18n="backgroundDesc2">
                            在川黔滇边境的崇山峻岭间，一场惊心动魄的<strong>"运动战"</strong>典范即将上演。这不是单纯的撤退，而是为了生存，在敌人重兵集团之间穿插迂回的绝地反击。
                        </p>
                    </div>
                </div>
                <div class="relative w-full h-[400px]">
                    <div id="vs-element" class="vs-container"><span class="vs-text">VS</span></div>
                    <div class="grid grid-cols-2 gap-4 h-full">
                        <div id="card-mao" class="h-full bg-flag-ccp rounded-lg shadow-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden anim-left-hidden">
                            <div class="text-overlay w-full h-full flex flex-col items-center justify-center">
                                <div class="w-28 h-28 rounded-full overflow-hidden border-4 border-yellow-300 shadow-lg mb-4 bg-gray-200">
                                    <img src="毛泽东.jpg" class="w-full h-full object-cover grayscale contrast-125" alt="毛泽东">
                                </div>
                                <h4 class="text-2xl font-bold text-yellow-300 mb-1" data-i18n="maoName">毛泽东</h4>
                                <p class="text-xs text-center text-white/90 leading-relaxed font-serif mt-2" data-i18n="maoDesc">
                                    中央红军实际指挥者<br>战略：<strong>避实击虚，声东击西</strong><br>"打得赢就打，打不赢就走"
                                </p>
                            </div>
                        </div>
                        <div id="card-chiang" class="h-full bg-flag-kmt rounded-lg shadow-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden anim-right-hidden">
                            <div class="text-overlay w-full h-full flex flex-col items-center justify-center">
                                <div class="w-28 h-28 rounded-full overflow-hidden border-4 border-white shadow-lg mb-4 bg-gray-200">
                                    <img src="蒋介石.jpg" class="w-full h-full object-cover grayscale contrast-125 object-top" alt="蒋介石">
                                </div>
                                <h4 class="text-2xl font-bold text-white mb-1" data-i18n="chiangName">蒋介石</h4>
                                <p class="text-xs text-center text-white/90 leading-relaxed font-serif mt-2" data-i18n="chiangDesc">
                                    国民党军最高统帅<br>战略：<strong>堡垒主义，铁壁合围</strong><br>"凭借天险，毕其功于一役"
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: 地图推演 -->
        <div class="page p-4 md:p-6" id="page3">
            <div class="max-w-[1600px] mx-auto w-full h-full flex flex-col">
                <div class="flex justify-between items-end mb-4 border-b border-white/20 pb-2">
                    <h2 class="section-title !mb-0 text-3xl text-white" data-i18n="sandTableTitle">沙盘推演</h2>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow h-[calc(100%-80px)]">
                    <!-- 左侧控制 -->
                    <div class="lg:col-span-3 flex flex-col gap-4 h-full overflow-y-auto pr-2">
                        <div class="glass-card p-5 border-none bg-white/90">
                            <div class="space-y-3" id="phase-buttons-container">
                                <!-- Generated by JS -->
                            </div>
                            <button onclick="app.playOverview()" class="w-full mt-6 py-3 bg-gray-800 text-white rounded-md shadow-lg hover:bg-red-700 transition font-bold flex items-center justify-center gap-2">
                                <i class="fas fa-film"></i> <span data-i18n="playAll">播放全景史诗</span>
                            </button>
                            
                            <!-- 新增：战术小窗 -->
                            <div id="tactical-reason-window" class="mini-window">
                                <div class="text-xs text-gray-500 uppercase tracking-wider mb-1">TACTICAL INTEL</div>
                                <div id="tactical-text" class="text-sm font-bold typing-effect">...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 地图容器 -->
                    <div class="lg:col-span-9 relative h-full">
                        <div id="map"></div>
                        <div class="absolute bottom-6 left-6 bg-white/95 backdrop-blur px-4 py-3 rounded-md shadow-lg border border-gray-300 text-xs z-[500] font-serif text-gray-800">
                            <div class="flex items-center mb-2"><span class="w-3 h-3 rounded-full bg-red-600 mr-2 shadow-sm"></span><span data-i18n="legendRed">中央红军主力</span></div>
                            <div class="flex items-center"><span class="w-8 h-0.5 border-t-4 border-dashed border-slate-900 mr-2 opacity-90"></span><span data-i18n="legendBlue">国民党军防线</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: 数据复盘 -->
        <div class="page p-8 md:p-16" id="page4">
            <div class="max-w-7xl mx-auto w-full">
                <h2 class="section-title text-center block mx-auto text-white" data-i18n="statsTitle">战役复盘</h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12 mt-8">
                    <div class="glass-card p-6 text-center border-b-4 border-yellow-500 relative overflow-hidden">
                        <!-- 动态日历效果 -->
                        <div class="text-4xl font-serif font-bold text-gray-800 flex justify-center items-baseline">
                            <span id="days-counter">0</span><span class="text-sm text-gray-500 ml-1" data-i18n="unitDays">天</span>
                        </div>
                        <div id="date-flip" class="text-xs text-red-600 mt-2 font-mono font-bold bg-red-50 py-1 rounded">1935.01.19</div>
                    </div>
                    <div class="glass-card p-6 text-center border-b-4 border-yellow-500">
                        <div class="text-4xl font-serif font-bold text-gray-800"><span id="total-distance-display">--</span><span class="text-sm text-gray-500 ml-1">km</span></div>
                        <div class="text-xs text-gray-400 mt-2 uppercase tracking-wide" data-i18n="statDistance">Distance</div>
                    </div>
                    <div class="glass-card p-6 text-center border-b-4 border-yellow-500" id="ratio-card">
                        <div class="text-4xl font-serif font-bold text-gray-800">1:10+</div>
                        <!-- 激光对抗条 -->
                        <div class="laser-bar-container">
                            <div class="laser-red"></div>
                            <div class="laser-blue"></div>
                            <div class="laser-clash"></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-2 uppercase tracking-wide" data-i18n="statRatio">Force Disparity</div>
                    </div>
                    <div class="glass-card p-6 text-center border-b-4 border-yellow-500">
                        <div class="text-4xl font-serif font-bold text-gray-800">4<span class="text-sm text-gray-500 ml-1" data-i18n="unitTimes">次</span></div>
                        <div class="text-xs text-gray-400 mt-2 uppercase tracking-wide" data-i18n="statCrossings">Crossings</div>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-white mb-6 pl-3 border-l-4 border-yellow-400 flex items-center">
                    <span data-i18n="keyPointsTitle">关键节点</span> <span class="text-xs font-normal text-white/70 ml-4 border border-white/30 px-2 py-0.5 rounded" data-i18n="clickHint">点击查看</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="location-cards">
                    <!-- Cards generated by JS -->
                </div>
            </div>
        </div>

        <!-- Page 5: 和平 -->
        <div class="page flex items-center justify-center" id="page5">
            <div class="dove-container absolute inset-0 pointer-events-none overflow-hidden">
                <i class="fas fa-dove dove dove-1"></i>
                <i class="fas fa-dove dove dove-2"></i>
            </div>
            
            <div class="relative z-10 flex flex-col items-center max-w-3xl mx-auto px-6 text-center">
                <div class="mb-8 p-6 border-2 border-white/20 rounded-full bg-white/10 backdrop-blur-sm peace-btn-container animate-breathe" onclick="app.showPeaceContent()">
                     <i class="fas fa-peace text-6xl text-white drop-shadow-md"></i>
                </div>
                <h1 class="text-5xl md:text-7xl font-black mb-6 text-white drop-shadow-lg font-serif tracking-tight">PEACE</h1>
                <div class="glass-card p-10 border-t border-white/50 peace-content" id="peace-content">
                    <div class="text-3xl font-serif font-bold text-sky-800 mb-6" data-i18n="peaceTitle">铭记历史 · 珍爱和平</div>
                    <p class="text-lg text-slate-600 leading-relaxed font-sans" data-i18n="peaceDesc">
                        四渡赤水不仅是军事指挥艺术的巅峰，更是人类在绝境中寻求生存与胜利的意志象征。<br>
                        回望战火，是为了更坚定地守护今天的安宁。
                    </p>
                </div>
                <button onclick="changePage(-4)" class="mt-12 px-8 py-3 bg-white text-sky-600 rounded-full hover:bg-sky-50 transition font-bold tracking-widest uppercase text-xs shadow-lg flex items-center gap-3">
                    <i class="fas fa-undo"></i> <span data-i18n="restart">重读历史</span>
                </button>
            </div>
        </div>

    </div>

    <div class="page-indicator">
        <div class="page-dot active" onclick="jumpToPage(1)"></div>
        <div class="page-dot" onclick="jumpToPage(2)"></div>
        <div class="page-dot" onclick="jumpToPage(3)"></div>
        <div class="page-dot" onclick="jumpToPage(4)"></div>
        <div class="page-dot" onclick="jumpToPage(5)"></div>
    </div>

    <!-- 模态框 -->
    <div id="detail-modal" class="fixed inset-0 hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm z-[99999]">
        <div class="modal-content bg-white w-full max-w-4xl h-[85vh] rounded-lg shadow-2xl overflow-hidden flex flex-col">
            <div class="bg-gray-50 px-8 py-5 flex justify-between items-center shrink-0 border-b border-gray-200">
                <div>
                    <h3 id="modal-title" class="text-3xl font-serif font-bold text-gray-800"></h3>
                    <p class="text-xs text-yellow-600 uppercase tracking-widest mt-1 font-bold">Tactical Analysis</p>
                </div>
                <button onclick="app.closeModal()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 transition text-gray-500 text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-8">
                    <div>
                        <h4 class="font-bold text-red-700 mb-3 text-lg flex items-center gap-2"><i class="fas fa-history"></i> <span data-i18n="modalHistory">史实背景</span></h4>
                        <p id="modal-desc" class="text-gray-600 text-base leading-7 text-justify font-serif"></p>
                    </div>
                    <div class="bg-yellow-50 p-5 rounded-md border border-yellow-100">
                        <h4 class="font-bold text-yellow-800 text-sm mb-2" data-i18n="modalStrategy">战略价值</h4>
                        <p id="modal-context" class="text-yellow-700 text-sm italic font-serif"></p>
                    </div>
                    <div class="grid grid-cols-3 gap-3" id="modal-stats-grid"></div>
                </div>
                <div class="flex flex-col bg-white p-4 rounded-md shadow-sm border border-gray-100">
                    <div class="flex-grow relative min-h-[250px]"><canvas id="chart-main"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 翻译数据字典 ---
        const TRANSLATIONS = {
            zh: {
                title: "四渡赤水",
                subtitle: "\"长征史上最光彩神奇的篇章\"",
                redArmyCount: "3.7<span class='text-lg opacity-70 ml-1'>万</span>",
                redArmyLabel: "中央红军",
                enemyCount: "40<span class='text-lg opacity-70 ml-1'>万</span>",
                enemyLabel: "国民党军",
                backgroundTitle: "战役背景",
                backgroundDesc1: "1935年1月，遵义会议确立了新的领导核心。此时，中央红军面临着国民党40万大军的铁壁合围，敌我力量对比高达10倍以上。",
                backgroundDesc2: "在川黔滇边境的崇山峻岭间，一场惊心动魄的<strong>\"运动战\"</strong>典范即将上演。这不是单纯的撤退，而是为了生存，在敌人重兵集团之间穿插迂回的绝地反击。",
                maoName: "毛泽东",
                maoDesc: "中央红军实际指挥者<br>战略：<strong>避实击虚，声东击西</strong><br>\"打得赢就打，打不赢就走\"",
                chiangName: "蒋介石",
                chiangDesc: "国民党军最高统帅<br>战略：<strong>堡垒主义，铁壁合围</strong><br>\"凭借天险，毕其功于一役\"",
                sandTableTitle: "沙盘推演",
                playAll: "播放全景史诗",
                legendRed: "中央红军主力",
                legendBlue: "国民党军防线",
                statsTitle: "战役复盘",
                unitDays: "天",
                statDistance: "迂回行军里程",
                statRatio: "敌我兵力比",
                statCrossings: "渡河次数",
                unitTimes: "次",
                keyPointsTitle: "关键节点深度解析",
                clickHint: "点击卡片查看详情",
                peaceTitle: "铭记历史 · 珍爱和平",
                peaceDesc: "四渡赤水不仅是军事指挥艺术的巅峰，更是人类在绝境中寻求生存与胜利的意志象征。<br>回望战火，是为了更坚定地守护今天的安宁。",
                restart: "重读历史",
                modalHistory: "史实背景",
                modalStrategy: "战略价值",
                
                // 动态数据 - Phases
                phases: [
                    { name: '一渡赤水', desc: '土城受挫，西渡避锋', reason: '土城战役受挫，情报误判敌军兵力。毛泽东果断决定“避实击虚”，放弃北渡，改为西渡赤水以避锋芒。', date: '01.29' },
                    { name: '二渡赤水', desc: '回师东进，二占遵义', reason: '川军加强长江防线，北渡困难。红军抓住敌军兵力空虚，突然回师东进，二渡赤水，直取遵义，攻其不备。', date: '02.18' },
                    { name: '三渡赤水', desc: '佯攻北渡，引敌西向', reason: '蒋介石重兵围剿遵义。红军再次西渡赤水，佯作北渡长江姿态，成功调动国民党军主力向西集结，掩盖真实战略意图。', date: '03.16' },
                    { name: '四渡赤水', desc: '秘密东渡，南突乌江', reason: '敌军主力被调往川南。红军秘密折返，四渡赤水，随后南下急行军突破乌江，兵锋直指贵阳，彻底跳出合围圈。', date: '03.21' }
                ],
                // 动态数据 - Locations
                locations: [
                    { id: 'tucheng', name: '土城战役', desc: '情报误判（敌川军兵力远超预期），战局陷入胶着。毛泽东审时度势，果断提议撤出战斗，西渡赤水。', context: '由被动应战向灵活战略转移的关键转折点。', metrics: { '我军': '3万余', '敌军': '川军主力', '结果': '主动撤出' }, labels: ['预估敌军', '实际敌军', '我军投入'], date: '1935.01.28' },
                    { id: 'zunyi', name: '遵义大捷', desc: '红军二渡赤水回师东进，攻克天险娄山关，再占遵义城。', context: '中央红军长征以来最大的一次胜利，极大鼓舞了全军士气。', metrics: { '歼敌': '1.8万', '俘虏': '约3000', '缴获': '大量枪支弹药' }, labels: ['歼灭/击溃', '俘虏', '其他'], date: '1935.02.28' },
                    { id: 'maotai', name: '茅台渡河', desc: '红军在茅台镇大举渡河，造成北渡长江的假象。', context: '一次极具战略眼光的战术欺骗，成功调动了敌军主力。', metrics: { '渡河兵力': '主力', '调动敌军': '数十万', '耗时': '约3天' }, labels: ['欺骗性', '机动性', '风险', '战略收益'], date: '1935.03.16' },
                    { id: 'taiping', name: '四渡突围', desc: '趁敌重兵西调，红军秘密东渡赤水，随即南下急行军。', context: '神来之笔，将40万大军甩在身后，实现了战略转移的决定性胜利。', metrics: { '红军': '主力', '敌军': '40万包围', '最高日行': '60km' }, labels: ['红军兵力', '敌军包围兵力'], date: '1935.03.22' }
                ]
            },
            en: {
                title: "Four Crossings",
                subtitle: "\"The most magical chapter in the Long March\"",
                redArmyCount: "37<span class='text-lg opacity-70 ml-1'>k</span>",
                redArmyLabel: "Red Army",
                enemyCount: "400<span class='text-lg opacity-70 ml-1'>k</span>",
                enemyLabel: "Opposition",
                backgroundTitle: "Background",
                backgroundDesc1: "Jan 1935, Zunyi Conference established new leadership. The Red Army faced encirclement by 400,000 Nationalist troops, outnumbered 10 to 1.",
                backgroundDesc2: "In the mountainous borders, a masterpiece of <strong>Mobile Warfare</strong> unfolded. Not just a retreat, but a desperate counterattack for survival.",
                maoName: "Mao Zedong",
                maoDesc: "Red Army Commander<br>Strategy: <strong>Mobile Warfare, Feint East Strike West</strong><br>\"Fight when you can win, move when you can't\"",
                chiangName: "Chiang Kai-shek",
                chiangDesc: "Nationalist Commander<br>Strategy: <strong>Fortress Tactics, Encirclement</strong><br>\"Rely on natural barriers to annihilate in one blow\"",
                sandTableTitle: "War Game",
                playAll: "Play Epic Overview",
                legendRed: "Red Army Main Force",
                legendBlue: "KMT Defense Line",
                statsTitle: "Campaign Review",
                unitDays: "Days",
                statDistance: "March Distance",
                statRatio: "Force Ratio",
                statCrossings: "Crossings",
                unitTimes: "Times",
                keyPointsTitle: "Key Tactical Analysis",
                clickHint: "Click for details",
                peaceTitle: "Remember History · Cherish Peace",
                peaceDesc: "The Four Crossings is not only a peak of military art but a symbol of human will to survive in desperation.<br>Looking back at war is to better guard the peace of today.",
                restart: "Replay History",
                modalHistory: "History",
                modalStrategy: "Strategy",
                
                phases: [
                    { name: '1st Crossing', desc: 'Setback at Tucheng, Westward Retreat', reason: 'Intelligence failure at Tucheng. Mao decided to "avoid strength", abandoning the north crossing to cross Chishui westwards.', date: 'Jan 29' },
                    { name: '2nd Crossing', desc: 'Return East, Retake Zunyi', reason: 'Yangtze heavily guarded. Red Army caught the enemy off guard by returning east, crossing Chishui again to retake Zunyi.', date: 'Feb 18' },
                    { name: '3rd Crossing', desc: 'Feint North, Lure Enemy West', reason: 'Chiang encircled Zunyi. Red Army crossed west again, feigning a north crossing to lure main KMT forces west.', date: 'Mar 16' },
                    { name: '4th Crossing', desc: 'Secret Return, Breakout South', reason: 'Enemy main force lured west. Red Army secretly returned east, crossed Chishui, broke through Wujiang southwards.', date: 'Mar 21' }
                ],
                locations: [
                    { id: 'tucheng', name: 'Battle of Tucheng', desc: 'Intelligence error led to stalemate. Mao decisively proposed withdrawal west across Chishui.', context: 'Turning point from passive defense to flexible strategic transfer.', metrics: { 'Red Army': '30k+', 'Enemy': 'Sichuan Army', 'Result': 'Withdrawal' }, labels: ['Est. Enemy', 'Act. Enemy', 'Red Army'], date: '1935.01.28' },
                    { id: 'zunyi', name: 'Zunyi Victory', desc: 'Red Army returned east, took Loushanguan and Zunyi. Wiped out 2 divisions and 8 regiments.', context: 'Largest victory since the Long March began, greatly boosting morale.', metrics: { 'Enemies': '18k', 'Captives': '3000', 'Loot': 'Massive Arms' }, labels: ['Annihilated', 'Captives', 'Others'], date: '1935.02.28' },
                    { id: 'maotai', name: 'Maotai Crossing', desc: 'Red Army crossed at Maotai, feigning a north crossing of Yangtze.', context: 'Strategic deception that successfully lured enemy main forces.', metrics: { 'Forces': 'Main', 'Lured': '100k+', 'Time': '3 Days' }, labels: ['Deception', 'Mobility', 'Risk', 'Gain'], date: '1935.03.16' },
                    { id: 'taiping', name: 'Breakout', desc: 'While enemy moved west, Red Army crossed east secretly and marched south rapidly.', context: 'Masterstroke that left 400k troops behind, achieving strategic victory.', metrics: { 'Red Army': 'Main', 'Enemy': '400k', 'Speed': '60km/day' }, labels: ['Red Army', 'Enemy Force'], date: '1935.03.22' }
                ]
            }
        };

        let currentLang = 'zh';
        let currentPage = 1;
        const totalPages = 5;
        const pages = document.querySelectorAll('.page');
        const dots = document.querySelectorAll('.page-dot');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');

        function updateUI() {
            pages.forEach((page, index) => {
                const pageNum = index + 1;
                page.classList.remove('active', 'prev', 'next');
                if (pageNum === currentPage) {
                    page.classList.add('active');
                    if(currentPage === 2) playPage2Animations(); else resetPage2Animations();
                    if(currentPage === 3 && app && app.map) setTimeout(() => app.map.invalidateSize(), 500);
                    if(currentPage === 4) app.playPage4Animations();
                } else if (pageNum < currentPage) {
                    page.classList.add('prev');
                } else {
                    page.classList.add('next');
                }
            });
            dots.forEach((dot, index) => dot.classList.toggle('active', index + 1 === currentPage));
            if (currentPage === 1) btnPrev.classList.add('disabled'); else btnPrev.classList.remove('disabled');
            if (currentPage === totalPages) btnNext.classList.add('disabled'); else btnNext.classList.remove('disabled');
        }

        function playPage2Animations() {
            setTimeout(() => { document.getElementById('p2-row1').classList.remove('anim-hidden'); document.getElementById('p2-row1').classList.add('anim-show'); }, 300);
            setTimeout(() => { document.getElementById('card-mao').classList.remove('anim-left-hidden'); document.getElementById('card-mao').classList.add('anim-slide-in'); }, 1200);
            setTimeout(() => { document.getElementById('card-chiang').classList.remove('anim-right-hidden'); document.getElementById('card-chiang').classList.add('anim-slide-in'); }, 2200);
            setTimeout(() => { document.getElementById('card-mao').classList.add('collide-left'); document.getElementById('card-chiang').classList.add('collide-right'); document.getElementById('vs-element').classList.add('vs-show'); }, 3200);
        }

        function resetPage2Animations() {
            const row1 = document.getElementById('p2-row1'); const mao = document.getElementById('card-mao'); const chiang = document.getElementById('card-chiang'); const vs = document.getElementById('vs-element');
            row1.classList.remove('anim-show'); row1.classList.add('anim-hidden');
            mao.classList.remove('anim-slide-in', 'collide-left'); mao.classList.add('anim-left-hidden');
            chiang.classList.remove('anim-slide-in', 'collide-right'); chiang.classList.add('anim-right-hidden');
            vs.classList.remove('vs-show');
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) { currentPage = newPage; updateUI(); }
        }
        function jumpToPage(pageNum) { currentPage = pageNum; updateUI(); }

        const app = (function() {
            const LOCS = {
                zunyi: [27.6922, 106.9286], tucheng: [28.3278, 106.4253], maotai: [27.8347, 106.3725],
                taiping: [28.1833, 106.2167], gulin: [28.0333, 105.8167], guiyang: [26.58, 106.71],
                wujiang: [27.15, 106.85], chishuiCity: [28.59, 105.69], loushanguan: [27.91, 106.85]
            };
            const PATHS = [
                [LOCS.zunyi, [28.1, 106.8], LOCS.tucheng, [28.25, 106.3], LOCS.gulin],
                [LOCS.gulin, [28.15, 106.1], LOCS.taiping, [28.0, 106.6], LOCS.loushanguan, LOCS.zunyi],
                [LOCS.zunyi, [27.75, 106.6], LOCS.maotai, [27.9, 106.1], LOCS.gulin],
                [LOCS.gulin, LOCS.taiping, [27.8, 106.4], [27.5, 106.6], LOCS.wujiang, [26.8, 106.7], [26.6, 106.6]]
            ];
            const KMT_LINES = [
                [[[28.6, 106.7], [28.35, 106.5]]], [[[28.1, 105.7], [27.7, 105.8]]], [[[27.7, 107.0], [27.7, 106.5]]], [[[28.0, 106.1], [28.0, 106.3]]] 
            ];
            
            // 数据源现在是函数，根据当前语言返回
            const getPhaseData = () => TRANSLATIONS[currentLang].phases;
            const getLocationsData = () => TRANSLATIONS[currentLang].locations;

            let map, activeLayers = [], animationFrameId, redPolyline = null, ballMarker = null, activeChart = null;

            function init() {
                map = L.map('map', { center: [27.95, 106.5], zoom: 9, zoomControl: false });
                L.control.zoom({ position: 'topright' }).addTo(map);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 12, minZoom: 7, attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(map);
                const riverCoords = [LOCS.chishuiCity, [28.4, 105.8], [28.3, 106.0], [28.2, 106.3], [27.9, 106.5], [27.7, 106.7], [27.5, 106.9]];
                L.polyline(riverCoords, { color: '#60a5fa', weight: 6, opacity: 0.5, lineCap: 'round' }).addTo(map);
                
                updateContent(); // 初始化内容
                calculateTotalDistance();
            }
            
            function setLanguage(lang) {
                currentLang = lang;
                document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
                document.getElementById('btn-en').classList.toggle('active', lang === 'en');
                updateContent();
            }

            function updateContent() {
                // 1. Update Static Text
                const texts = TRANSLATIONS[currentLang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (texts[key]) el.innerHTML = texts[key];
                });

                // 2. Update Phase Buttons
                const phasesContainer = document.getElementById('phase-buttons-container');
                phasesContainer.innerHTML = '';
                getPhaseData().forEach((phase, idx) => {
                    phasesContainer.innerHTML += `
                        <button onclick="app.playPhase(${idx})" class="phase-btn w-full text-left p-4 rounded-md bg-gray-50 hover:bg-red-50 border-l-4 border-gray-300 hover:border-red-600 transition group mb-3">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-gray-800 text-lg group-hover:text-red-700">${phase.name}</span>
                                <span class="text-xs font-mono text-gray-400">${phase.date}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1 pl-1">${phase.desc}</div>
                        </button>`;
                });

                // 3. Update Location Cards
                renderCards();
            }

            function calculateTotalDistance() {
                setTimeout(() => {
                    let totalMeters = 0;
                    PATHS.forEach(path => { for(let i=0; i < path.length - 1; i++) totalMeters += map.distance(path[i], path[i+1]); });
                    const el = document.getElementById('total-distance-display'); if(el) { el.innerText = Math.round(totalMeters / 1000); el.classList.add('animate-pulse'); }
                }, 1000);
            }

            function renderCards() {
                const container = document.getElementById('location-cards');
                container.innerHTML = '';
                const locations = getLocationsData();
                const colors = ['#dc2626', '#16a34a', '#2563eb', '#b91c1c'];
                const icons = ['fas fa-water', 'fas fa-landmark', 'fas fa-wine-bottle', 'fas fa-bridge'];
                
                locations.forEach((loc, index) => {
                    const card = document.createElement('div');
                    card.className = "glass-card p-5 cursor-pointer hover:shadow-2xl hover:border hover:border-white transition duration-300 transform hover:-translate-y-1 group";
                    card.innerHTML = `<div class="flex items-center gap-4 mb-3"><div class="w-12 h-12 rounded-full flex items-center justify-center text-white shadow-md transition" style="background:${colors[index]}"><i class="${icons[index]} text-lg"></i></div><div><h4 class="font-bold text-gray-800 text-lg transition">${loc.name}</h4><span class="text-xs font-mono text-gray-500 border-b border-gray-300">${loc.date}</span></div></div><p class="text-xs text-gray-600 line-clamp-2 mb-3 leading-relaxed">${loc.desc}</p><div class="flex justify-end"><span class="text-xs font-bold text-yellow-600 opacity-0 group-hover:opacity-100 transition transform translate-x-2 group-hover:translate-x-0">${TRANSLATIONS[currentLang].clickHint} <i class="fas fa-arrow-right ml-1"></i></span></div>`;
                    
                    // Inject chart data for detail view
                    // We map metrics and labels from the current lang data object
                    // Note: Original chartData structure needs to be reconstructed in showDetail
                    card.onclick = () => showDetail(loc.id); 
                    container.appendChild(card);
                });
            }

            function updateReason(index) {
                const el = document.getElementById('tactical-text');
                if(el) {
                    el.style.opacity = 0;
                    setTimeout(() => {
                        el.innerText = getPhaseData()[index].reason;
                        el.style.opacity = 1;
                    }, 200);
                }
            }

            function clearStage() { if (animationFrameId) cancelAnimationFrame(animationFrameId); activeLayers.forEach(l => map.removeLayer(l)); activeLayers = []; }

            function animatePath(coords, duration, phaseIdx, callback) {
                redPolyline = L.polyline([], { color: '#dc2626', weight: 4, opacity: 0.8, lineJoin: 'round', className: 'ink-path' }).addTo(map); activeLayers.push(redPolyline);
                const icon = L.divIcon({ className: 'red-army-ball', iconSize: [16, 16] }); ballMarker = L.marker(coords[0], { icon: icon, zIndexOffset: 9999 }).addTo(map); activeLayers.push(ballMarker);
                const d = getPhaseData()[phaseIdx];
                const popContent = `<div class="font-sans p-2 text-sm"><h4 class="font-bold text-red-700 border-b border-gray-200 mb-2 pb-1">${d.name}</h4><div class="text-xs text-gray-600">${d.desc}</div></div>`;
                ballMarker.bindPopup(popContent, { className: 'tactical-popup', closeButton: false, autoClose: false, minWidth: 140 });
                let totalDist = 0; for(let i=0; i<coords.length-1; i++) totalDist += map.distance(coords[i], coords[i+1]);
                let start = null;
                function step(ts) {
                    if (!start) start = ts; const p = (ts - start) / duration;
                    if (p >= 1) { redPolyline.setLatLngs(coords); ballMarker.setLatLng(coords[coords.length-1]); ballMarker.openPopup(); if(callback) callback(); return; }
                    const curD = totalDist * p; let cv = 0; let cp = coords[0]; let pts = [coords[0]];
                    for(let i=0; i<coords.length-1; i++) {
                        const dist = map.distance(coords[i], coords[i+1]);
                        if (dist <= 0.1) { cv += dist; pts.push(coords[i+1]); continue; }
                        if (cv + dist > curD) { const r = (curD - cv) / dist; cp = [coords[i][0] + (coords[i+1][0]-coords[i][0])*r, coords[i][1] + (coords[i+1][1]-coords[i][1])*r]; pts.push(cp); break; } else { cv += dist; pts.push(coords[i+1]); }
                    }
                    ballMarker.setLatLng(cp); redPolyline.setLatLngs(pts); map.panTo(cp, {animate: false}); animationFrameId = requestAnimationFrame(step);
                }
                animationFrameId = requestAnimationFrame(step);
            }

            function playPhase(index) {
                clearStage(); updateReason(index);
                // 颜色加深，线条变粗
                KMT_LINES[index].forEach(line => { const l = L.polyline(line, { color: '#0f172a', weight: 3, dashArray: '5, 8', opacity: 0.9 }).addTo(map); activeLayers.push(l); });
                setTimeout(() => { animatePath(PATHS[index], 4000, index); }, 1000);
            }

            function playOverview() {
                clearStage(); let idx = 0;
                function next() {
                    if (idx >= 4) return;
                    updateReason(idx);
                    KMT_LINES[idx].forEach(line => { const l = L.polyline(line, { color: '#0f172a', weight: 3, dashArray: '4, 6', opacity: 0.9 }).addTo(map); activeLayers.push(l); });
                    const coords = PATHS[idx]; if (idx > 0 && ballMarker) map.removeLayer(ballMarker);
                    const poly = L.polyline([], { color: '#dc2626', weight: 3, opacity: 0.6 }).addTo(map); activeLayers.push(poly);
                    const icon = L.divIcon({ className: 'red-army-ball', iconSize: [16, 16] }); ballMarker = L.marker(coords[0], { icon: icon, zIndexOffset: 9999 }).addTo(map); activeLayers.push(ballMarker);
                    let start = null; const dur = 2000; let totalDist = 0; for(let i=0; i<coords.length-1; i++) totalDist += map.distance(coords[i], coords[i+1]);
                    function step(ts) {
                        if (!start) start = ts; const p = (ts - start) / dur;
                        if (p >= 1) { poly.setLatLngs(coords); ballMarker.setLatLng(coords[coords.length-1]); idx++; next(); return; }
                        const curD = totalDist * p; let cv = 0; let cp = coords[0]; let pts = [coords[0]];
                        for(let i=0; i<coords.length-1; i++) {
                            const dist = map.distance(coords[i], coords[i+1]);
                            if (cv + dist > curD) { const r = (curD - cv) / dist; cp = [coords[i][0] + (coords[i+1][0]-coords[i][0])*r, coords[i][1] + (coords[i+1][1]-coords[i][1])*r]; pts.push(cp); break; } else { cv += dist; pts.push(coords[i+1]); }
                        }
                        ballMarker.setLatLng(cp); poly.setLatLngs(pts); map.panTo(cp, {animate: false}); animationFrameId = requestAnimationFrame(step);
                    }
                    animationFrameId = requestAnimationFrame(step);
                }
                next();
            }

            function playPage4Animations() {
                const ratioCard = document.getElementById('ratio-card');
                if(ratioCard) {
                    ratioCard.classList.remove('animate-lasers');
                    void ratioCard.offsetWidth;
                    ratioCard.classList.add('animate-lasers');
                }

                // 延迟启动日历翻动
                setTimeout(() => {
                    let count = 0; const target = 72; const duration = 4000; 
                    const counterEl = document.getElementById('days-counter');
                    const dateEl = document.getElementById('date-flip');
                    const startTs = new Date('1935-01-19').getTime();
                    const endTs = new Date('1935-03-31').getTime();
                    const range = endTs - startTs;
                    
                    const startTime = performance.now();
                    function anim(currentTime) {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        count = Math.floor(progress * target);
                        if(counterEl) counterEl.innerText = count;

                        const currentTs = startTs + (range * progress);
                        const d = new Date(currentTs);
                        const dateStr = `1935.${(d.getMonth()+1).toString().padStart(2,'0')}.${d.getDate().toString().padStart(2,'0')}`;
                        if(dateEl) dateEl.innerText = dateStr;

                        if(progress < 1) requestAnimationFrame(anim);
                    }
                    requestAnimationFrame(anim);
                }, 1000); // 增加延迟至1s
            }

            function showDetail(id) {
                const loc = getLocationsData().find(l => l.id === id); if (!loc) return;
                const modal = document.getElementById('detail-modal');
                document.getElementById('modal-title').innerText = loc.name;
                document.getElementById('modal-desc').innerText = loc.desc;
                document.getElementById('modal-context').innerText = loc.context;
                document.getElementById('modal-stats-grid').innerHTML = Object.entries(loc.metrics).map(([k,v]) => `<div class="bg-gray-50 p-2 rounded border border-gray-200 text-center"><div class="text-[10px] text-gray-400 uppercase tracking-wide">${k}</div><div class="font-bold text-red-700">${v}</div></div>`).join('');
                if(activeChart) activeChart.destroy();
                const ctx = document.getElementById('chart-main').getContext('2d');
                
                let chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } };
                let chartType = 'bar'; // Default
                let bgColors = ['#fbbf24', '#1e293b', '#b91c1c']; 
                
                // Reconstruct data based on ID and current language labels
                let chartDataValues = [];
                if(id === 'tucheng') chartDataValues = [4000, 20000, 10000];
                else if(id === 'zunyi') chartDataValues = [18000, 3000, 2000];
                else if(id === 'maotai') chartDataValues = [95, 85, 50, 95];
                else if(id === 'taiping') chartDataValues = [30000, 400000];

                // Reset animation
                chartOptions.animation = {};

                if (id === 'tucheng' || id === 'taiping') {
                    chartType = 'bar';
                    chartOptions.animation = {
                        duration: 2000,
                        easing: 'easeOutQuart', // Smooth growth
                        y: { from: 0 }
                    };
                }
                else if (id === 'zunyi') {
                    chartType = 'pie';
                    chartOptions.animation = {
                        animateScale: true, animateRotate: true, duration: 1500, easing: 'easeOutQuart'
                    };
                    bgColors = ['#0f172a', '#ef4444', '#fbbf24']; // 黑蓝 -> 红 -> 黄
                }
                else if (id === 'maotai') {
                    chartType = 'radar';
                    chartOptions.scales = {
                        r: { min: 0, max: 100, beginAtZero: true, ticks: { stepSize: 20, backdropColor: 'transparent' }, pointLabels: { font: { size: 12 } } }
                    };
                    chartOptions.animation = {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    };
                }

                activeChart = new Chart(ctx, {
                    type: chartType,
                    data: { 
                        labels: loc.labels, 
                        datasets: [{ 
                            label: loc.name, 
                            data: chartDataValues, 
                            backgroundColor: chartType === 'radar' ? 'rgba(251, 191, 36, 0.5)' : bgColors,
                            borderColor: chartType === 'radar' ? '#fbbf24' : undefined,
                            borderWidth: chartType === 'radar' ? 2 : 1 
                        }] 
                    },
                    options: chartOptions
                });
                modal.classList.remove('hidden');
            }

            function closeModal() { document.getElementById('detail-modal').classList.add('hidden'); }
            
            function showPeaceContent() {
                document.getElementById('peace-content').classList.add('show');
            }

            return { init, setLanguage, playPhase, playOverview, playPage4Animations, closeModal, showDetail, showPeaceContent, map };
        })();

        window.onload = () => { app.init(); updateUI(); };
        document.addEventListener('keydown', (e) => { if(e.key === 'ArrowRight') changePage(1); if(e.key === 'ArrowLeft') changePage(-1); });
    </script>
</body>
</html>
